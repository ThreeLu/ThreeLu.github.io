{% include base_path %}

<section class="page__share">
  {% if site.data.ui-text[site.locale].share_on_label %}
    <h4 class="page__share-title">{{ site.data.ui-text[site.locale].share_on_label | default: "Share on" }}</h4>
  {% endif %}

  <!-- 原有平台 -->
  <a href="https://www.facebook.com/sharer/sharer.php?u={{ base_path }}{{ page.url | url_encode }}" class="btn btn--facebook" title="{{ site.data.ui-text[site.locale].share_on_label | default: 'Share on' }} Facebook">
    <i class="fab fa-facebook" aria-hidden="true"></i><span> Facebook</span>
  </a>
  <a href="https://x.com/intent/post?text={{ base_path }}{{ page.url | url_encode }}" class="btn btn--x" title="{{ site.data.ui-text[site.locale].share_on_label | default: 'Share on' }} X">
    <i class="fab fa-x-twitter" aria-hidden="true"></i><span> X </span>
  </a>

  <!-- 差异化 QQ 分享容器（动态渲染） -->
  <div id="qq-share-container"></div>

  <!-- 微信分享（不变） -->
  <button class="btn btn--wechat" id="wechat-share-btn" title="{{ site.data.ui-text[site.locale].share_on_label | default: 'Share on' }} 微信">
    <i class="fab fa-weixin" aria-hidden="true"></i><span> 微信</span>
  </button>
  <div id="wechat-tip" style="display: none; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
    链接已复制：<span id="copy-url">{{ base_path }}{{ page.url }}</span>，打开微信粘贴分享即可
  </div>

  <script>
    // ========== 核心：设备检测（区分移动端/桌面端） ==========
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const shareUrl = '{{ base_path }}{{ page.url }}'; // 待分享的完整URL
    const pageTitle = '{{ page.title | default: "分享内容" }}'; // 分享标题

    // ========== 动态渲染 QQ 分享按钮 ==========
    const qqContainer = document.getElementById('qq-share-container');
    if (isMobile) {
      // 移动端：渲染「唤起QQ客户端」的链接（适配手机/平板）
      qqContainer.innerHTML = `
        <a href="mqq://share/menu?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(pageTitle)}" 
           class="btn btn--qq" 
           target="_blank" 
           rel="noopener noreferrer"
           title="Share on QQ">
          <i class="fab fa-qq" aria-hidden="true"></i><span> QQ</span>
        </a>
        <!-- 移动端唤起失败提示（默认隐藏） -->
        <div id="mobile-qq-tip" style="display: none; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
          未唤起QQ？请手动复制链接：<span>${shareUrl}</span>
        </div>
      `;
      // 移动端QQ唤起失败处理
      const qqBtn = qqContainer.querySelector('.btn--qq');
      const qqTip = qqContainer.querySelector('#mobile-qq-tip');
      qqBtn.addEventListener('click', (e) => {
        // 2秒后检测是否唤起成功，未成功则显示提示
        setTimeout(() => {
          qqTip.style.display = 'block';
          // 5秒后隐藏提示
          setTimeout(() => { qqTip.style.display = 'none'; }, 5000);
        }, 2000);
      });
    } else {
      // 桌面端：渲染「复制链接」按钮（避免转圈）
      qqContainer.innerHTML = `
        <button class="btn btn--qq" id="pc-qq-share-btn" title="Share on QQ">
          <i class="fab fa-qq" aria-hidden="true"></i><span> QQ</span>
        </button>
        <div id="pc-qq-tip" style="display: none; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
          QQ分享链接已复制：<span>${shareUrl}</span>，打开QQ粘贴分享即可
        </div>
      `;
      // 桌面端QQ复制链接逻辑
      const qqBtn = qqContainer.querySelector('#pc-qq-share-btn');
      const qqTip = qqContainer.querySelector('#pc-qq-tip');
      qqBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(shareUrl).then(() => {
          qqTip.style.display = 'block';
          setTimeout(() => { qqTip.style.display = 'none'; }, 3000);
        }).catch(err => {
          alert('QQ链接复制失败，请手动复制：' + shareUrl);
        });
      });
    }

    // ========== 微信复制逻辑（不变） ==========
    const wechatBtn = document.getElementById('wechat-share-btn');
    const wechatTip = document.getElementById('wechat-tip');
    const copyUrl = document.getElementById('copy-url').textContent;

    wechatBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(copyUrl).then(() => {
        wechatTip.style.display = 'block';
        setTimeout(() => {
          wechatTip.style.display = 'none';
        }, 3000);
      }).catch(err => {
        alert('复制失败，请手动复制：' + copyUrl);
      });
    });
  </script>
</section>
