{% include base_path %}

<div class="page__comments">
  {% capture comments_label %}{{ site.data.ui-text[site.locale].comments_label | default: "评论区" }}{% endcapture %}
  {% case site.comments.provider %}
  {% when "disqus" %}
    <h4 class="page__comments-title">{{ comments_label }}</h4>
    <section id="disqus_thread"></section>
    {% include /comments-providers/disqus.html %}
  {% when "facebook" %}
    <h4 class="page__comments-title">{{ comments_label }}</h4>
    <section class="fb-comments" data-href="{{ base_path }}{{ page.url }}" data-mobile="true" data-num-posts="{{ site.comments.facebook.num_posts | default: 5 }}" data-width="100%" data-colorscheme="{{ site.comments.facebook.colorscheme | default: 'light' }}"></section>
  {% when "google-plus" %}
    <h4 class="page__comments-title">{{ comments_label }}</h4>
    <section class="g-comments" data-href="{{ base_path }}{{ page.url }}" data-first_party_property="BLOGGER" data-view_type="FILTERED_POSTMOD">加载评论中...</section>
  {% when "staticman" %}
    <section id="comments">
      {% if site.repository and site.staticman.branch %}
        <!-- 已有的评论列表 -->
        <div class="js-comments">
          {% if site.data.comments[page.slug] %}
            <h4 class="page__comments-title">{{ site.data.ui-text[site.locale].comments_title | default: "已有评论" }}</h4>
            {% assign comments = site.data.comments[page.slug] | sort %}

            {% for comment in comments %}
              {% assign email = comment[1].email %}
              {% assign name = comment[1].name %}
              {% assign url = comment[1].url %}
              {% assign date = comment[1].date %}
              {% assign message = comment[1].message %}
              {% include comment.html index=forloop.index email=email name=name url=url date=date message=message %}
            {% endfor %}
          {% endif %}
        </div>

        <!-- 评论提交表单（核心修改） -->
        <h4 class="page__comments-title">{{ site.data.ui-text[site.locale].comments_label | default: "发表评论" }}</h4>
        <p class="small">你的邮箱不会被公开，带<span class="required">*</span>为必填项</p>
        <form id="new_comment" class="page__comments-form js-form form" method="post" action="https://staticman3.herokuapp.com/v3/entry/github/gh-pages/ThreeLu/ThreeLu.github.io/_data/comments/{options.slug}">
          <div class="form__spinner">
            <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
            <span class="sr-only">加载中...</span>
          </div>

          <!-- 评论内容 -->
          <fieldset>
            <label for="comment-form-message">评论 <small class="required">*</small></label>
            <textarea type="text" rows="3" id="comment-form-message" name="fields[message]" tabindex="1" required></textarea>
            <div class="small help-block">支持Markdown格式（如**加粗**、[链接](url)）</div>
          </fieldset>
          
          <!-- 姓名 -->
          <fieldset>
            <label for="comment-form-name">姓名 <small class="required">*</small></label>
            <input type="text" id="comment-form-name" name="fields[name]" tabindex="2" required />
          </fieldset>
          
          <!-- 邮箱 -->
          <fieldset>
            <label for="comment-form-email">邮箱 <small class="required">*</small>（仅生成头像，不公开）</label>
            <input type="email" id="comment-form-email" name="fields[email]" tabindex="3" required />
          </fieldset>
          
          <!-- 个人主页（可选） -->
          <fieldset>
            <label for="comment-form-url">个人主页（可选）</label>
            <input type="url" id="comment-form-url" name="fields[url]" tabindex="4"/>
          </fieldset>
          
          <!-- 隐藏字段（必须保留） -->
          <fieldset class="hidden">
            <input type="hidden" name="options[slug]" value="{{ page.slug }}">
            <input type="hidden" name="fields[hidden]"/>
          </fieldset>
          
          <!-- 提示信息 -->
          <p class="hidden js-notice">
            <strong class="js-notice-text"></strong>
          </p>
          
          <!-- 提交按钮 -->
          <fieldset>
            <button type="submit" id="comment-form-submit" tabindex="5" class="btn btn--large">提交评论</button>
          </fieldset>
        </form>
      {% endif %}
    </section>
  {% when "custom" %}
    <h4 class="page__comments-title">{{ comments_label }}</h4>
    <section id="comments"></section>
    {% include /comments-providers/scripts.html %}
  {% endcase %}
</div>
